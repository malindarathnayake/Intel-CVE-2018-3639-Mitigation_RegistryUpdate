#Malinda Rathnayake | WCA 2018
#Hot fix ID to check for - get the KB number from M$ Security Blog or from your WSUS server
[string]$BaseHotfixFid = "KB4284880"
#
#this will Query the current Hotfixes Present on the system, installed Date field will be $null if its pending install
#
#
#Check if the Registery values are already Present - WIP
#
$gethotfix = Get-WmiObject -Class "win32_quickfixengineering" | Where-Object {$_.InstalledOn -ne $null} |
Select-Object -Property "Description", "HotfixID", 
@{Name="InstalledOn"; Expression={([DateTime]($_.InstalledOn)).ToLocalTime()}}
#
$hotfixid = $gethotfix.HotfixID -replace '[KB]'
$BaseHFid = $BaseHotfixFid -replace '[KB]'
#
#Check and Apply the Patch
if ($hotfixid -eq "$BaseHFid")
{ 
#https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution
#these updates will change depending on the variants they discover so far there have been two, considering these are hardware issues there is bound to be more in the future
#
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v FeatureSettingsOverride /t REG_DWORD /d 8 /f
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v FeatureSettingsOverrideMask /t REG_DWORD /d 3 /f
#write-host  "you good"
$PatchApplied = "1"
} else{
write-host  "no good" 
$PatchApplied = "0"}
#
#email Notice
#
$EmailSubject = "Intel CVE-2018-3639 Mitigation_$(get-date -format 'dd-MMMM-yyyy')"
$EmailRecipients = ""
$EmailFrom = ""
$EmailSMTPServer = ''
$EmailEncoding = [System.Text.Encoding]::UTF7 #UTF7,UTF8,ASCII

if ($PatchApplied -eq '1')
{$EmailText = "Intel CVE-2018-3639 Mitigation_RegistryUpdates_Applied_sucessfully"} else {$EmailText = "Intel CVE-2018-3639 Mitigation_RegistryUpdates_Pending_Please Update your Host OS"}
#
Send-MailMessage -To $EmailRecipients -Subject $EmailSubject -From $EmailFrom -Body $EmailText -SmtpServer $EmailSMTPServer -Encoding $EmailEncoding -Attachments $Attachment
#
$EmailText
